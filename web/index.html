<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NextChapter — Calm Start</title>
  <meta name="description" content="A quiet, agent-first guide for job loss or career change. One next step at a time." />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body style="display:none">
  <div class="wrap">
    <header>
      <a class="logo" href="#"><span class="mark">N</span> NextChapter</a>
      <div style="display:flex; gap:.5rem;">
        <button id="open-library" class="btn ghost" aria-expanded="false">Tools</button>
        <button id="reset" class="btn ghost" title="Clear saved state">Reset</button>
      </div>
    </header>

    <!-- Screen 1: Welcome -->
    <section id="scr-welcome" class="screen active">
      <div class="card panel center">
        <h1>We got you! Step by step you'll get there.</h1>
        <p class="muted">I’ll ask one or two things, then show just your next step.</p>
        <div class="choices tiles">
          <button class="tile" data-choice="lost" style="--bg:url('img/home1b.png');"><span class="label">I just lost my job</span></button>
          <button class="tile" data-choice="explore" style="--bg:url('img/home3.png');"><span class="label">I’m exploring a change</span></button>
          <button class="tile" data-choice="stuck" style="--bg:url('img/home4b.png');"><span class="label">I’m stuck in my job</span></button>
        </div>
        <button id="skip-intake" class="btn">Skip — just give me a plan</button>
      </div>
    </section>

    <!-- Screen 2: Mini Intake -->
    <section id="scr-intake" class="screen">
      <div class="card panel center">
        <h2>Just three quick taps</h2>
        <div class="intake">
          <div class="row" role="group" aria-label="Urgency">
            <span class="label">Urgency</span>
            <button class="chip" data-urgency="low">Low</button>
            <button class="chip" data-urgency="medium">Medium</button>
            <button class="chip" data-urgency="high">High</button>
          </div>
          <div class="row" role="group" aria-label="Energy">
            <span class="label">Energy</span>
            <button class="chip" data-energy="low">Low</button>
            <button class="chip" data-energy="ok">OK</button>
            <button class="chip" data-energy="good">Good</button>
          </div>
          <div class="row" role="group" aria-label="Where are you?">
            <span class="label">Where are you?</span>
            <button class="chip" data-stage="stabilize">Stabilize</button>
            <button class="chip" data-stage="reframe">Reframe</button>
            <button class="chip" data-stage="position">Position</button>
            <button class="chip" data-stage="explore">Explore</button>
            <button class="chip" data-stage="apply">Apply</button>
            <button class="chip" data-stage="secure">Secure</button>
            <button class="chip" data-stage="transition">Transition</button>
            <button class="chip" data-stage="unsure">Not sure</button>
          </div>
          <button id="btn-next-step" class="btn primary">Get my next step</button>
        </div>
      </div>
    </section>

    <!-- Screen 3: Today Card -->
    <section id="scr-today" class="screen">
      <div class="card panel today">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:1rem">
          <!-- Phase pill is a button -->
          <button id="phase-chip" class="phase" type="button" aria-haspopup="dialog" aria-expanded="false">Phase · Week</button>
          <button id="btn-standup" class="btn ghost">Daily check-in</button>
        </div>
        <div class="todo">
          <h2>Do today — one deep, one quick, one tiny</h2>
          <ul id="todo-list" class="muted" style="margin:.2rem 0 0 1rem"></ul>
          <div style="display:flex; gap:.6rem; margin-top:.6rem; flex-wrap:wrap">
            <button id="btn-sprint" class="btn primary">Start 25-min Sprint</button>
            <button id="btn-open-coach" class="btn">Talk to Coach</button>
          </div>
        </div>
        <details class="more"><summary>Show weekly plan</summary>
          <div id="plan-status" class="muted" style="margin-top:.6rem"></div>
          <div id="plan-md" class="muted" style="margin-top:.6rem"></div>
        </details>
      </div>
    </section>
  </div>

  <!-- Phase change popover -->
  <div id="phase-pop" class="phase-pop" aria-hidden="true" role="dialog" aria-labelledby="phase-pop-title">
    <div class="phase-card">
      <h3 id="phase-pop-title">Adjust phase & week</h3>
      <div class="form-row">
        <label for="phase-select" class="label">Phase</label>
        <select id="phase-select" class="select">
          <option value="stabilize">Stabilize</option>
          <option value="reframe">Reframe</option>
          <option value="position">Position</option>
          <option value="explore">Explore</option>
          <option value="apply">Apply</option>
          <option value="secure">Secure</option>
          <option value="transition">Transition</option>
        </select>
      </div>
      <div class="form-row">
        <label for="week-input" class="label">Week</label>
        <input id="week-input" class="number" type="number" min="1" max="16" step="1" />
      </div>
      <div class="phase-actions">
        <button id="phase-cancel" class="btn ghost" type="button">Cancel</button>
        <button id="phase-save" class="btn primary" type="button">Save</button>
      </div>
    </div>
  </div>

  <!-- Coach Panel -->
  <button id="fab" class="btn btn-primary coach-fab" aria-controls="coach" aria-expanded="false">Coach</button>
  <aside id="coach" class="coach-panel" aria-hidden="true" role="dialog" aria-labelledby="coach-title">
    <header class="coach-header">
      <h2 id="coach-title" style="margin:0">Your Coach</h2>
      <button id="coach-close" class="btn ghost">Close</button>
    </header>
    <div class="coach-tools">
      <button class="pill btn btn-primary" data-kind="plan">Weekly Plan</button>
      <button class="pill btn btn-primary" data-kind="standup">Check-in</button>
      <button class="pill btn btn-primary" data-kind="gate">Phase Gate</button>
      <button class="pill btn btn-primary" data-kind="triage">If I’m anxious</button>
    </div>
    <div class="coach-body">
      <div id="coach-output" class="coach-output" aria-live="polite"></div>
    </div>
    <form class="coach-footer" id="coach-form">
      <input id="coach-input" class="coach-input" type="text" autocomplete="off" placeholder="Type a question… (Enter to send, Shift+Enter for newline)" />
      <button id="coach-send" class="btn primary" type="submit">Send</button>
    </form>
  </aside>

  <!-- Library Drawer -->
  <div id="drawer" class="drawer" aria-hidden="true">
    <div style="display:flex; align-items:center; justify-content:space-between; padding:1rem; border-bottom:1px solid var(--border)">
      <strong>Tools, when you want them</strong>
      <button id="close-drawer" class="btn ghost">Close</button>
    </div>
    <div class="grid">
      <article class="card panel">
        <h3>CV & LinkedIn Lab</h3>
        <p class="muted">Evidence-led improvements, fast.</p>
        <a class="btn" href="cv.html">Open</a>
      </article>
      <article class="card panel">
        <h3>Application Tracker</h3>
        <p class="muted">Keep momentum with follow-ups.</p>
        <a class="btn" href="tracker.html">Open</a>
      </article>
      <article class="card panel">
        <h3>Interview Simulator</h3>
        <p class="muted">Practice senior-level prompts.</p>
        <a class="btn" href="interview.html">Start</a>
      </article>
      <article class="card panel">
        <h3>Financial Checklist</h3>
        <p class="muted">ALV, health, pension — step-by-step.</p>
        <a class="btn" href="financial.html">Download</a>
      </article>
      <article class="card panel">
        <h3>Stress Management</h3>
        <p class="muted">Quick exercises to stay steady.</p>
        <a class="btn" href="stress.html">Open</a>
      </article>
    </div>
  </div>

  <!-- Sprint Panel -->
  <div id="sprint" class="sprint-panel" aria-hidden="true">
    <div class="sprint-card">
      <h3 style="margin:0 0 .2rem">25-min Sprint</h3>
      <div id="sprint-timer">25:00</div>
      <div class="sprint-controls">
        <button id="sprint-start" class="btn primary">Start</button>
        <button id="sprint-pause" class="btn">Pause</button>
        <button id="sprint-reset" class="btn ghost">Reset</button>
        <button id="sprint-done" class="btn ghost">Done</button>
      </div>
      <p id="sprint-tip" class="sprint-tip">Tip: pick one item from “Do today”. Close extra tabs.</p>
    </div>
  </div>

  <footer>Last updated by Codex <span id="deploy-time"></span></footer>
  <script>
      const PASSWORD_KEY = 'jtbd_pwd';
      const VALID_PASSWORD = 'newCareer25!';
      let stored = sessionStorage.getItem(PASSWORD_KEY);
      if (stored !== VALID_PASSWORD) {
        stored = prompt('Enter password:');
        if (stored !== VALID_PASSWORD) {
          document.body.innerHTML = '<h1>Access denied</h1>';
          document.body.style.display = '';
          throw new Error('Unauthorized');
        }
        sessionStorage.setItem(PASSWORD_KEY, stored);
      }
      document.body.style.display = '';
      document.getElementById('deploy-time').textContent = new Date(document.lastModified).toLocaleString();
    // ---------- Config & Utilities ----------
    const API_BASE = "/"; // same-origin with Flask
    const stateKey = "jtbd_state_v1";
    let userState = JSON.parse(localStorage.getItem(stateKey) || "null") || {
      current_phase: null, week_in_phase: 1, energy: null, urgency: null
    };
    let lastContext = null; // {kind, md} of last tool panel
    if (typeof window.cap !== "function") { window.cap = s => (s || "").replace(/^\w/, c => c.toUpperCase()); }
    marked.setOptions({ gfm: true, breaks: true });

    function renderMarkdown(md, el){
      try { el.innerHTML = DOMPurify.sanitize(marked.parse(md || "")); }
      catch { el.textContent = md || ""; }
    }

    function addToolsSection(md){
      const tools = '\n\n## Tools\n- [CV & LinkedIn Lab](cv.html)\n- [Application Tracker](tracker.html)\n- [Interview Simulator](interview.html)\n- [Financial Checklist](financial.html)\n';
      if(!md) return tools.trimStart();
      return md.includes('## Tools') ? md : md.trimEnd() + tools;
    }

    // ---------- Screen nav ----------
    const scrWelcome = document.getElementById('scr-welcome');
    const scrIntake  = document.getElementById('scr-intake');
    const scrToday   = document.getElementById('scr-today');
    function show(id){ [scrWelcome,scrIntake,scrToday].forEach(s=>s.classList.remove('active')); id.classList.add('active'); }

function fitWelcomeTiles(){
      const labels = Array.from(document.querySelectorAll('#scr-welcome .tile .label'));
      labels.forEach(l => l.style.fontSize = '');
      let smallest = Infinity;
      labels.forEach(label => {
        let size = parseFloat(getComputedStyle(label).fontSize);
        while (label.scrollWidth > label.clientWidth && size > 8) {
          size -= 1;
          label.style.fontSize = size + 'px';
        }
        smallest = Math.min(smallest, size);
      });
      labels.forEach(label => { label.style.fontSize = smallest + 'px'; });
    }
    fitWelcomeTiles();
    window.addEventListener('resize', fitWelcomeTiles);
    
    // Reset (clear saved state)
    document.getElementById('reset').addEventListener('click', ()=>{
      localStorage.removeItem(stateKey);
      userState = { current_phase:null, week_in_phase:1, energy:null, urgency:null };
      show(scrWelcome);
    });

    // Welcome → Intake / Skip
    document.querySelectorAll('#scr-welcome .tile').forEach(btn=>{
      btn.addEventListener('click', ()=>{ show(scrIntake); });
    });
    document.getElementById('skip-intake').addEventListener('click', ()=>{
      if(!userState.current_phase){ userState.current_phase = 'stabilize'; userState.week_in_phase = 1; }
      persist(); initToday();
    });

    // ---------- Intake chips ----------
    const btnNextStep = document.getElementById('btn-next-step');
    let tmp = { urgency:null, energy:null, stage:null };
    function updateNextStepButton(){
      if(tmp.urgency && tmp.energy && tmp.stage){
        btnNextStep.className = 'pill btn-primary';
      } else {
        btnNextStep.className = 'btn primary';
      }
    }
    ['urgency','energy','stage'].forEach(key=>{
      document.querySelectorAll(`[data-${key}]`).forEach(b=>{
        b.addEventListener('click', (e)=>{
          const v = e.currentTarget.dataset[key];
          tmp[key]=v;
          const group = e.currentTarget.parentElement;
          group.querySelectorAll('.chip').forEach(c=>c.setAttribute('aria-pressed','false'));
          e.currentTarget.setAttribute('aria-pressed','true');
          updateNextStepButton();
        });
      });
    });
    updateNextStepButton();
    btnNextStep.addEventListener('click', ()=>{
      userState.urgency = tmp.urgency || 'medium';
      userState.energy  = tmp.energy  || 'low';
      userState.current_phase = (tmp.stage && tmp.stage!=='unsure') ? tmp.stage : 'stabilize';
      userState.week_in_phase = 1;
      persist(); initToday();
    });
    function persist(){ localStorage.setItem(stateKey, JSON.stringify(userState)); }

    // ---------- Today Card ----------
    const phaseChip = document.getElementById('phase-chip');
    const todoList  = document.getElementById('todo-list');
    const planMd    = document.getElementById('plan-md');
    const planStatus = document.getElementById('plan-status');

    async function initToday(){
      const phaseLabel = (typeof cap === "function")
        ? cap(userState.current_phase || 'stabilize')
        : (userState.current_phase || 'stabilize');
      phaseChip.textContent = `${phaseLabel} · Week ${userState.week_in_phase || 1}`;
      show(scrToday);

      planStatus.textContent = 'Generating weekly plan…';
      planMd.innerHTML = '';
      todoList.innerHTML = '<li>Generating daily plan…</li>';
      const plan = await callCoach('plan', userState, 'Return a Weekly Plan; include a section starting with "Do today (90/30/15)".');
      const planWithTools = addToolsSection(plan);
      renderMarkdown(planWithTools, planMd);
      renderDoToday(planWithTools);
      planStatus.textContent = '';
    }

    // Robust task extraction
    function renderDoToday(md){
      const tasks = extractDoToday(md);
      todoList.innerHTML = tasks.length
        ? tasks.map(t => `<li>${DOMPurify.sanitize(t)}</li>`).join('')
        : '<li>Open the Coach and tap “Weekly Plan”.</li>';
    }
    function extractDoToday(md){
      if (!md) return [];
      const lines = md.split(/\r?\n/);
      const out = [];
      const grab = (rx) => { for (const ln of lines) { const m = ln.match(rx); if (m && m[1] && m[1].trim()) return m[1].trim(); } return null; };
      const rx90 = /(?:^|\s)(?:[-*•]\s*)?(?:\*\*?\s*)?(?:90\s*min|90m|90)\s*(?:[:\-–—]\s*)(.+)$/i;
      const rx30 = /(?:^|\s)(?:[-*•]\s*)?(?:\*\*?\s*)?(?:30\s*min|30m|30)\s*(?:[:\-–—]\s*)(.+)$/i;
      const rx15 = /(?:^|\s)(?:[-*•]\s*)?(?:\*\*?\s*)?(?:15\s*min|15m|15)\s*(?:[:\-–—]\s*)(.+)$/i;
      const t90 = grab(rx90); if (t90) out.push(`90 min — ${t90}`);
      const t30 = grab(rx30); if (t30) out.push(`30 min — ${t30}`);
      const t15 = grab(rx15); if (t15) out.push(`15 min — ${t15}`);
      if (out.length) return out;
      const ix = md.toLowerCase().indexOf('do today');
      if (ix >= 0) {
        const after = md.slice(ix);
        const bullets = [];
        const re = /\n\s*[-*•]\s+(.+?)(?=\n|$)/g;
        let m; while ((m = re.exec(after)) && bullets.length < 3) { const txt = (m[1] || '').trim(); if (txt) bullets.push(txt); }
        if (bullets.length) return bullets;
      }
      const chkIdx = md.toLowerCase().indexOf('checklist');
      if (chkIdx >= 0) {
        const after = md.slice(chkIdx);
        const bullets = [];
        const re = /\n\s*(?:[-*•]|☐)\s+(.+?)(?=\n|$)/g;
        let m; while ((m = re.exec(after)) && bullets.length < 3) { const txt = (m[1] || '').trim(); if (txt) bullets.push(txt); }
        if (bullets.length) return bullets;
      }
      return [];
    }

    // ---------- Phase popover logic ----------
    const phasePop = document.getElementById('phase-pop');
    const phaseSelect = document.getElementById('phase-select');
    const weekInput = document.getElementById('week-input');
    const phaseCancel = document.getElementById('phase-cancel');
    const phaseSave = document.getElementById('phase-save');

    const phases = ['stabilize','reframe','position','explore','apply','secure','transition'];

    // Week ranges per phase
    const PHASE_WEEKS = {
      stabilize: 3,
      reframe: 3,
      position: 6,
      explore: 6,
      apply: 8,
      secure: 4,
      transition: 4
    };

    function openPhasePop(){
      const cur = (userState.current_phase && phases.includes(userState.current_phase)) ? userState.current_phase : 'stabilize';
      const maxW = PHASE_WEEKS[cur] || 8;

      phaseSelect.value = cur;
      weekInput.min = 1;
      weekInput.max = String(maxW);
      weekInput.value = Math.min(Math.max(1, userState.week_in_phase || 1), maxW);

      phasePop.classList.add('open');
      phasePop.setAttribute('aria-hidden','false');
      phaseChip.setAttribute('aria-expanded','true');
      setTimeout(()=>phaseSelect.focus(), 0);

      phasePop.addEventListener('click', onPhaseBackdrop);
      window.addEventListener('keydown', onPhaseEsc);
    }
    function closePhasePop(){
      phasePop.classList.remove('open');
      phasePop.setAttribute('aria-hidden','true');
      phaseChip.setAttribute('aria-expanded','false');
      phasePop.removeEventListener('click', onPhaseBackdrop);
      window.removeEventListener('keydown', onPhaseEsc);
      phaseChip.focus();
    }
    function onPhaseBackdrop(e){ if(e.target === phasePop) closePhasePop(); }
    function onPhaseEsc(e){ if(e.key === 'Escape') closePhasePop(); }

    phaseChip.addEventListener('click', openPhasePop);
    phaseCancel.addEventListener('click', closePhasePop);

    phaseSelect.addEventListener('change', ()=>{
      const p = phaseSelect.value;
      const maxW = PHASE_WEEKS[p] || 8;
      weekInput.max = String(maxW);
      if(+weekInput.value > maxW) weekInput.value = maxW;
    });

    phaseSave.addEventListener('click', async ()=>{
      const p = phaseSelect.value;
      const maxW = PHASE_WEEKS[p] || 8;
      const w = Math.max(1, Math.min(maxW, parseInt(weekInput.value || '1', 10)));

      userState.current_phase = phases.includes(p) ? p : 'stabilize';
      userState.week_in_phase = w;
      persist();
      // Clear out old plan immediately and show loading state
      planStatus.textContent = 'Generating weekly plan…';
      planMd.innerHTML = '';
      todoList.innerHTML = '<li>Generating daily plan…</li>';
      // Reset coach panel so stale content isn't shown
      const activeTool = document.querySelector('.coach-tools .btn.active');
      if (activeTool) {
        coachOut.innerHTML = '<em>Generating…</em>';
      } else {
        coachOut.innerHTML = '';
      }
      lastContext = null;
      closePhasePop();
      await initToday(); // refresh plan + tasks
      // If a tool was active, regenerate it with updated phase
      if (activeTool) {
        const kind = activeTool.dataset.kind;
        const note = (kind === 'triage') ? 'Use Emotional Spike format.' : '';
        let md = await callCoach(kind, userState, note);
        if (['plan','standup','gate'].includes(kind)) md = addToolsSection(md);
        lastContext = { kind, md };
        renderCoach(md);
      }
    });

    // ---------- Coach panel (quick tools + chat) ----------
    const fab = document.getElementById('fab');
    const coach = document.getElementById('coach');
    const coachClose = document.getElementById('coach-close');
    const coachOut = document.getElementById('coach-output');
    function renderCoach(md){
      renderMarkdown(md, coachOut);
      coachOut.scrollTop = 0;
    }

    // Active tool helpers
    const toolButtons = Array.from(document.querySelectorAll('.coach-tools .btn'));
    function setActiveTool(btn){
      toolButtons.forEach(b=>{
        const on = (btn && b === btn);
        b.classList.toggle('active', on);
        b.setAttribute('aria-pressed', on ? 'true' : 'false');
      });
    }

    function openCoach(){
      coach.classList.add('open');
      coach.setAttribute('aria-hidden','false');
      fab.setAttribute('aria-expanded','true');
      fab.hidden = true; // hide FAB so it can’t overlap
      setActiveTool(null); // default to free chat view
      // move focus inside the panel so hidden trigger doesn't retain focus
      setTimeout(()=>{
        const input = document.getElementById('coach-input');
        (input || coachClose).focus();
      }, 0);
    }
    function closeCoach(){
      // return focus to the FAB before hiding the panel to avoid aria-hidden conflicts
      fab.hidden = false;
      fab.setAttribute('aria-expanded','false');
      fab.focus();
      coach.classList.remove('open');
      coach.setAttribute('aria-hidden','true');
    }
    fab.onclick = openCoach; document.getElementById('btn-open-coach').onclick = openCoach; coachClose.onclick = closeCoach;

    // Quick tools
    document.querySelectorAll('.coach-tools .btn').forEach(b=>{
      b.addEventListener('click', async ()=>{
        setActiveTool(b);
        const kind = b.dataset.kind;
        const note = (kind==='triage') ? 'Use Emotional Spike format.' : '';
        coachOut.innerHTML = '<em>Generating…</em>';
        let md = await callCoach(kind, userState, note);
        if(['plan','standup','gate'].includes(kind)) md = addToolsSection(md);
        lastContext = { kind, md };              // store panel context
        renderCoach(md);
      });
    });

    // Chat composer
    const form = document.getElementById('coach-form');
    const input = document.getElementById('coach-input');
    const sendBtn = document.getElementById('coach-send');

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text = (input.value || '').trim();
      if(!text) return;
      openCoach();
      setActiveTool(null); // chat mode, not a quick tool
      appendChat('user', text);
      input.value = '';
      input.disabled = true; sendBtn.disabled = true;

      const md = await askCoach(text, lastContext);
      appendChat('coach', md);

      input.disabled = false; sendBtn.disabled = false;
      input.focus();
    });
    input.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        form.dispatchEvent(new Event('submit', {cancelable:true}));
      }
    });

    function appendChat(role, mdOrText){
      const div = document.createElement('div');
      div.className = `msg msg-${role}`;
      const html = role === 'user'
        ? DOMPurify.sanitize(marked.parseInline(String(mdOrText)))
        : DOMPurify.sanitize(marked.parse(String(mdOrText || '')));
      div.innerHTML = html;
      coachOut.appendChild(div);
      coachOut.scrollTop = coachOut.scrollHeight;
    }

    async function askCoach(message, context){
      const payload = { user_state: mapState(userState), message };
      if (context && context.md){
        payload.context_md = String(context.md).slice(0, 4000);
        payload.context_kind = context.kind || 'unknown';
      }
      try{
        const r = await fetch(`${API_BASE}chat`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if (r.ok){
          const data = await r.json();
          return data.reply || 'No content.';
        }
      } catch(_) {}

      // Fallback if /chat is missing: still include the context in the note
      const ctx = context && context.md
        ? `\n\nContext (from ${context.kind}):\n${String(context.md).slice(0,2000)}\n`
        : '';
      return await callCoach('standup', userState,
        `Answer the user's question about the context below. If they say "bullet 1", find the first actionable bullet and help with it step-by-step.${ctx}\nQuestion: ${message}`
      );
    }

    // Daily stand-up shortcut (also sets context + highlight)
    document.getElementById('btn-standup').addEventListener('click', async ()=>{
      openCoach();
      const standupBtn = document.querySelector('.coach-tools .btn[data-kind="standup"]');
      setActiveTool(standupBtn);
      coachOut.innerHTML='<em>Generating…</em>';
      let md = await callCoach('standup', userState, 'Keep it tight.');
      md = addToolsSection(md);
      lastContext = { kind: 'standup', md };
      renderCoach(md);
    });

    // ---------- Library drawer ----------
    const drawer = document.getElementById('drawer');
    const openLib = document.getElementById('open-library');
    const closeLib = document.getElementById('close-drawer');
    openLib.onclick = ()=>{ drawer.classList.add('open'); openLib.setAttribute('aria-expanded','true'); };
    closeLib.onclick = ()=>{ drawer.classList.remove('open'); openLib.setAttribute('aria-expanded','false'); };
    if (location.hash === '#tools') {
      drawer.classList.add('open');
      openLib.setAttribute('aria-expanded','true');
    }

    // ---------- API calls ----------
    async function callCoach(kind, state, note){
      try{
        const res = await fetch(`${API_BASE}${kind}`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ user_state: mapState(state), note })
        });
        const data = await res.json();
        return data.reply || data.error || 'No content.';
      }catch(e){
        console.error(e);
        return 'Error contacting coach: '+e.message;
      }
    }
    function mapState(s){ return { current_phase: s.current_phase||'stabilize', week_in_phase: s.week_in_phase||1, energy: s.energy, urgency: s.urgency }; }

    // ---------- Sprint panel ----------
    const sprint = document.getElementById('sprint');
    const sprintTimer = document.getElementById('sprint-timer');
    const sprintTip = document.getElementById('sprint-tip');
    const sprintStart = document.getElementById('sprint-start');
    const sprintPause = document.getElementById('sprint-pause');
    const sprintReset = document.getElementById('sprint-reset');
    const sprintDone = document.getElementById('sprint-done');

    let sprintMs = 25*60*1000;
    let remaining = sprintMs;
    let rafId = null;
    let running = false;
    let lastTs = 0;

    function fmt(ms){ const t = Math.max(0, Math.round(ms/1000)); const m = Math.floor(t/60); const s = t%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
    function openSprint(){
      sprint.classList.add('open'); sprint.setAttribute('aria-hidden','false');
      resetSprint();
      sprintTip.textContent = 'Tip: choose one task from “Do today”. Close extra tabs.';
    }
    function closeSprint(){ stopSprint(); sprint.classList.remove('open'); sprint.setAttribute('aria-hidden','true'); }
    function startSprint(){
      if(running) return;
      running = true;
      lastTs = performance.now();
      rafId = requestAnimationFrame(tickSprint);
    }
    function pauseSprint(){
      if(!running) return;
      running = false;
      cancelAnimationFrame(rafId);
    }
    function stopSprint(){
      running = false;
      cancelAnimationFrame(rafId);
    }
    function resetSprint(){
      stopSprint();
      remaining = sprintMs;
      sprintTimer.textContent = fmt(remaining);
    }
    function tickSprint(ts){
      const dt = ts - lastTs; lastTs = ts;
      remaining -= dt;
      sprintTimer.textContent = fmt(remaining);
      if (remaining <= 0){
        completeSprint();
        return;
      }
      rafId = requestAnimationFrame(tickSprint);
    }
    function completeSprint(){
      stopSprint();
      remaining = 0;
      sprintTimer.textContent = '00:00';
      sprintTip.textContent = 'Nice work — want a quick check-in?';
      openCoach();
      appendChat('coach', '_Great sprint!_ Tell me one win, one blocker, and your next micro-step.');
    }

    document.getElementById('btn-sprint').addEventListener('click', openSprint);
    sprintStart.addEventListener('click', startSprint);
    sprintPause.addEventListener('click', pauseSprint);
    sprintReset.addEventListener('click', resetSprint);
    sprintDone.addEventListener('click', closeSprint);
    sprint.addEventListener('click', (e)=>{ if(e.target === sprint) closeSprint(); });
    window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && sprint.classList.contains('open')) closeSprint(); });

    // ---------- Auto-resume ----------
    if(userState.current_phase){ initToday(); }
  </script>
</body>
</html>
